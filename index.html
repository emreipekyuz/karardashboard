<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Y√∂netim Panosu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', sans-serif; }
        .hidden { display: none !important; }
        
        /* Gƒ∞Rƒ∞≈û EKRANI (TAM EKRAN KAPLAMA) */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #212529; z-index: 9999;
            display: flex; align-items: center; justify-content: center;
        }
        .login-box { background: white; padding: 2.5rem; border-radius: 12px; width: 90%; max-width: 400px; text-align: center; }
        
        /* KART STƒ∞LLERƒ∞ */
        .project-card { cursor: pointer; transition: all 0.2s; border-left: 5px solid #0d6efd; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .project-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box shadow-lg">
        <h3 class="mb-4"><i class="fas fa-lock text-primary"></i> G√ºvenli Giri≈ü</h3>
        <input type="password" id="loginPass" class="form-control mb-3 text-center" placeholder="Y√∂netici ≈ûifresi" autofocus onkeyup="if(event.key === 'Enter') login()">
        <button class="btn btn-primary w-100" onclick="login()">Giri≈ü Yap</button>
        <div id="loginError" class="alert alert-danger mt-3 small hidden">Hatalƒ± ≈ûifre!</div>
    </div>
</div>

<div id="mainApp" class="hidden">
    <nav class="navbar navbar-dark bg-dark mb-4">
        <div class="container">
            <span class="navbar-brand"><i class="fas fa-layer-group me-2"></i>Dernek Y√∂netim</span>
            <div>
                <button id="backBtn" class="btn btn-outline-light btn-sm hidden me-2" onclick="showProjectList()">
                    <i class="fas fa-arrow-left"></i> Projeler
                </button>
                <button class="btn btn-danger btn-sm" onclick="logout()" title="G√ºvenli √áƒ±kƒ±≈ü"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div id="loader" class="text-center py-5 hidden"><div class="spinner-border text-primary"></div><p>Y√ºkleniyor...</p></div>

        <div id="projectListView">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>üìÅ Projeler</h4>
                <button class="btn btn-success" onclick="yeniProjeEkle()"><i class="fas fa-plus"></i> Yeni Proje</button>
            </div>
            <div class="row" id="projectContainer"></div>
        </div>

        <div id="dashboardView" class="hidden">
            <h3 id="currentProjectTitle" class="mb-3 text-primary border-bottom pb-2"></h3>
            
            <div class="row mb-3 text-center">
                <div class="col-4"><div class="card p-2 border-0 shadow-sm"><h4 id="statTotal" class="mb-0">0</h4><small class="text-muted">Toplam</small></div></div>
                <div class="col-4"><div class="card p-2 border-0 shadow-sm"><h4 id="statPending" class="text-warning mb-0">0</h4><small class="text-muted">Bekleyen</small></div></div>
                <div class="col-4"><div class="card p-2 border-0 shadow-sm"><h4 id="statDone" class="text-success mb-0">0</h4><small class="text-muted">Tamamlandƒ±</small></div></div>
            </div>

            <button class="btn btn-primary w-100 mb-3" data-bs-toggle="modal" data-bs-target="#ekleModal">
                <i class="fas fa-plus-circle"></i> Yeni Karar Ekle
            </button>

            <div class="card p-3 border-0 shadow-sm">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light"><tr><th>ID</th><th>Tarih</th><th>Karar</th><th>Sorumlu</th><th>Durum</th><th class="text-end">ƒ∞≈ülem</th></tr></thead>
                        <tbody id="tabloGovdesi"></tbody>
                    </table>
                </div>
            </div>
            
            <div class="mt-5 text-center">
                 <button class="btn btn-outline-danger btn-sm" onclick="projeSil()"><i class="fas fa-trash-alt"></i> Bu Projeyi Tamamen Sil</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="ekleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Yeni Karar</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <input type="text" class="form-control mb-2" id="e_metin" placeholder="Karar Metni" required>
                <select class="form-select mb-2" id="e_kategori"><option>Genel</option><option>Mali</option><option>Etkinlik</option></select>
                <input type="text" class="form-control mb-2" id="e_sorumlu" placeholder="Sorumlu Ki≈üi">
                <input type="date" class="form-control mb-2" id="e_sonTarih">
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-primary" onclick="kararEkle()">Kaydet</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="duzenleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">D√ºzenle</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <input type="hidden" id="d_id">
                <input type="text" class="form-control mb-2" id="d_metin">
                <select class="form-select mb-2" id="d_kategori"><option>Genel</option><option>Mali</option><option>Etkinlik</option></select>
                <input type="text" class="form-control mb-2" id="d_sorumlu">
                <input type="date" class="form-control mb-2" id="d_sonTarih">
                <select class="form-select mb-2" id="d_durum"><option>Bekliyor</option><option>ƒ∞≈ülemde</option><option>Tamamlandƒ±</option><option>ƒ∞ptal</option></select>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-primary" onclick="kararGuncelle()">G√ºncelle</button></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- L√úTFEN URL'Yƒ∞ G√úNCELLE ---
    const API_URL = "https://script.google.com/macros/s/AKfycbynOEa3kA9PLqgghdiV4p2LB4FCtTFdEDqcRoIMfcJB1JuR-lR7fLIYBHMKhvgD3TATUA/exec";
    
    // Deƒüi≈ükenler
    let SESSION_KEY = sessionStorage.getItem('dernekKey'); // Varsa hafƒ±zadan al
    let currentSheetName = "";

    function loader(show) { document.getElementById('loader').className = show ? "text-center py-5" : "hidden"; }

    // SAYFA A√áILDIƒûINDA
    window.onload = function() {
        if (SESSION_KEY) {
            // Hafƒ±zada ≈üifre varsa direkt girmeyi dene
            login(true);
        }
    };

    // --- Gƒ∞Rƒ∞≈û Sƒ∞STEMƒ∞ ---
    async function login(autoLogin = false) {
        const pass = autoLogin ? SESSION_KEY : document.getElementById('loginPass').value;
        if (!pass) return;

        // Buton animasyonu (Otomatik giri≈üte gerek yok)
        if (!autoLogin) {
            const btn = document.querySelector('.login-box button');
            btn.disabled = true; btn.innerText = "Kontrol ediliyor...";
        }

        try {
            // ≈ûifreyi test et (Proje listesini isteyerek)
            const res = await fetch(API_URL + "?action=getProjects&key=" + pass);
            const data = await res.json();

            if (data.status === "error") {
                // ≈ûifre Yanlƒ±≈ü
                document.getElementById('loginError').classList.remove('hidden');
                document.getElementById('loginError').innerText = "≈ûifre Yanlƒ±≈ü!";
                sessionStorage.removeItem('dernekKey'); // Hatalƒ±ysa sil
                if (!autoLogin) { 
                    const btn = document.querySelector('.login-box button');
                    btn.disabled = false; btn.innerText = "Giri≈ü Yap";
                }
            } else {
                // ≈ûifre Doƒüru -> ƒ∞√ßeri Al
                SESSION_KEY = pass;
                sessionStorage.setItem('dernekKey', pass); // Hafƒ±zaya kaydet (F5 i√ßin)
                
                document.getElementById('loginOverlay').style.display = 'none'; // Giri≈ü ekranƒ±nƒ± u√ßur
                document.getElementById('mainApp').classList.remove('hidden'); // Uygulamayƒ± a√ß
                renderProjects(data); // Projeleri bas
            }
        } catch(e) {
            console.error(e);
            if(!autoLogin) {
                alert("Baƒülantƒ± hatasƒ±! URL'yi veya interneti kontrol et.");
                const btn = document.querySelector('.login-box button');
                btn.disabled = false; btn.innerText = "Giri≈ü Yap";
            }
        }
    }

    function logout() {
        sessionStorage.removeItem('dernekKey'); // Hafƒ±zayƒ± temizle
        location.reload(); // Sayfayƒ± yenile (Giri≈ü ekranƒ±na atar)
    }

    // --- PROJE FONKSƒ∞YONLARI ---
    function renderProjects(projects) {
        const container = document.getElementById('projectContainer');
        container.innerHTML = "";
        projects.forEach(p => {
            container.innerHTML += `
            <div class="col-md-4 mb-3">
                <div class="card project-card p-4" onclick="openProject('${p}')">
                    <h5 class="mb-0 text-dark"><i class="fas fa-folder text-warning me-2"></i>${p}</h5>
                </div>
            </div>`;
        });
    }

    async function loadProjects() {
        loader(true);
        const res = await fetch(API_URL + "?action=getProjects&key=" + SESSION_KEY);
        const data = await res.json();
        renderProjects(data);
        loader(false);
    }

    async function yeniProjeEkle() {
        const ad = prompt("Yeni Proje Adƒ±:");
        if (!ad) return;
        loader(true);
        const res = await fetch(API_URL + "?action=createProject&name=" + encodeURIComponent(ad) + "&key=" + SESSION_KEY);
        const data = await res.json();
        if (data.status === "success") { loadProjects(); } else { alert(data.message); loader(false); }
    }
    
    async function projeSil() {
        if (!confirm("BU PROJE VE ƒ∞√áƒ∞NDEKƒ∞ T√úM VERƒ∞LER Sƒ∞Lƒ∞NECEK! Emin misin?")) return;
        loader(true);
        const res = await fetch(API_URL + "?action=deleteProject&name=" + encodeURIComponent(currentSheetName) + "&key=" + SESSION_KEY);
        const data = await res.json();
        if (data.status === "success") { showProjectList(); loadProjects(); } else { alert(data.message); loader(false); }
    }

    // --- DASHBOARD (KARAR) FONKSƒ∞YONLARI ---
    function openProject(name) {
        currentSheetName = name;
        document.getElementById('currentProjectTitle').innerText = name;
        document.getElementById('projectListView').classList.add('hidden');
        document.getElementById('dashboardView').classList.remove('hidden');
        document.getElementById('backBtn').classList.remove('hidden');
        kararlariGetir();
    }

    function showProjectList() {
        document.getElementById('dashboardView').classList.add('hidden');
        document.getElementById('backBtn').classList.add('hidden');
        document.getElementById('projectListView').classList.remove('hidden');
    }

    async function kararlariGetir() {
        loader(true);
        const res = await fetch(API_URL + "?action=read&sheetName=" + encodeURIComponent(currentSheetName) + "&key=" + SESSION_KEY);
        const data = await res.json();
        
        const tbody = document.getElementById('tabloGovdesi');
        tbody.innerHTML = "";

        if (data.length > 0 && !data.status) { 
            // ƒ∞statistikler
            document.getElementById('statTotal').innerText = data.length;
            document.getElementById('statPending').innerText = data.filter(x => x.Durum === 'Bekliyor').length;
            document.getElementById('statDone').innerText = data.filter(x => x.Durum === 'Tamamlandƒ±').length;
            
            // Tabloyu Doldur
            data.reverse().forEach(item => {
                let color = item.Durum === 'Tamamlandƒ±' ? 'success' : (item.Durum === 'ƒ∞ptal' ? 'danger' : 'warning');
                tbody.innerHTML += `
                    <tr>
                        <td class="text-muted small">#${item.ID}</td>
                        <td>${formatDate(item.Tarih)}</td>
                        <td class="fw-bold">${item['Karar Metni']}</td>
                        <td>${item.Sorumlu}</td>
                        <td><span class="badge bg-${color}">${item.Durum}</span></td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-primary" onclick='modalAc(${JSON.stringify(item)})'><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-outline-danger" onclick="kararSil(${item.ID})"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
        } else { tbody.innerHTML = "<tr><td colspan='6' class='text-center py-3 text-muted'>Hen√ºz kayƒ±t yok.</td></tr>"; }
        loader(false);
    }

    // Ekle / Sil / G√ºncelle (≈ûifreyi otomatik kullanƒ±r)
    async function kararEkle() {
        const veri = {
            kararMetni: document.getElementById('e_metin').value,
            kategori: document.getElementById('e_kategori').value,
            sorumlu: document.getElementById('e_sorumlu').value,
            sonTarih: document.getElementById('e_sonTarih').value
        };
        loader(true);
        await fetch(API_URL + "?action=add&sheetName=" + encodeURIComponent(currentSheetName) + "&key=" + SESSION_KEY, { method: "POST", body: JSON.stringify(veri) });
        bootstrap.Modal.getInstance(document.getElementById('ekleModal')).hide();
        kararlariGetir();
    }

    async function kararSil(id) {
        if(!confirm("Silmek istediƒüine emin misin?")) return;
        loader(true);
        await fetch(API_URL + "?action=delete&id=" + id + "&sheetName=" + encodeURIComponent(currentSheetName) + "&key=" + SESSION_KEY);
        kararlariGetir();
    }

    async function kararGuncelle() {
        const veri = {
            id: document.getElementById('d_id').value,
            kararMetni: document.getElementById('d_metin').value,
            kategori: document.getElementById('d_kategori').value,
            sorumlu: document.getElementById('d_sorumlu').value,
            sonTarih: document.getElementById('d_sonTarih').value,
            durum: document.getElementById('d_durum').value
        };
        loader(true);
        await fetch(API_URL + "?action=update&sheetName=" + encodeURIComponent(currentSheetName) + "&key=" + SESSION_KEY, { method: "POST", body: JSON.stringify(veri) });
        bootstrap.Modal.getInstance(document.getElementById('duzenleModal')).hide();
        kararlariGetir();
    }

    // Modal ve Yardƒ±mcƒ±lar
    function modalAc(item) {
        document.getElementById('d_id').value = item.ID;
        document.getElementById('d_metin').value = item['Karar Metni'];
        document.getElementById('d_kategori').value = item.Kategori;
        document.getElementById('d_sorumlu').value = item.Sorumlu;
        document.getElementById('d_sonTarih').value = item['Son Tarih'];
        document.getElementById('d_durum').value = item.Durum;
        new bootstrap.Modal(document.getElementById('duzenleModal')).show();
    }

    function formatDate(d) { return d && d.includes("T") ? d.split("T")[0] : d; }
</script>
</body>
</html>
