<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proje Y√∂netim Panosu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        .project-card { cursor: pointer; transition: transform 0.2s; border-left: 5px solid #0d6efd; }
        .project-card:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark mb-4">
    <div class="container">
        <span class="navbar-brand"><i class="fas fa-layer-group me-2"></i>Dernek Proje Sistemi</span>
        <button id="backBtn" class="btn btn-outline-light btn-sm hidden" onclick="showProjectList()">
            <i class="fas fa-arrow-left"></i> Projelere D√∂n
        </button>
    </div>
</nav>

<div class="container">
    <div id="loader" class="text-center py-5 hidden"><div class="spinner-border text-primary"></div><p>ƒ∞≈ülem yapƒ±lƒ±yor...</p></div>

    <div id="projectListView">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4>üìÅ Projeler</h4>
            <button class="btn btn-success" onclick="yeniProjeEkle()"><i class="fas fa-plus"></i> Yeni Proje</button>
        </div>
        <div class="row" id="projectContainer">
            </div>
    </div>

    <div id="dashboardView" class="hidden">
        <h3 id="currentProjectTitle" class="mb-3 text-primary border-bottom pb-2"></h3>
        
        <div class="row mb-3 text-center">
            <div class="col-4"><div class="card p-2 bg-white"><h4 id="statTotal">0</h4><small>Toplam</small></div></div>
            <div class="col-4"><div class="card p-2 bg-white"><h4 id="statPending" class="text-warning">0</h4><small>Bekleyen</small></div></div>
            <div class="col-4"><div class="card p-2 bg-white"><h4 id="statDone" class="text-success">0</h4><small>Bitti</small></div></div>
        </div>

        <button class="btn btn-primary w-100 mb-3" data-bs-toggle="modal" data-bs-target="#ekleModal">
            <i class="fas fa-plus-circle"></i> Bu Projeye Karar Ekle
        </button>

        <div class="card p-3">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr><th>ID</th><th>Tarih</th><th>Karar</th><th>Sorumlu</th><th>Durum</th><th class="text-end">ƒ∞≈ülem</th></tr>
                    </thead>
                    <tbody id="tabloGovdesi"></tbody>
                </table>
            </div>
        </div>
        
        <div class="mt-5 text-center">
             <button class="btn btn-outline-danger btn-sm" onclick="projeSil()"><i class="fas fa-trash-alt"></i> Bu Projeyi Tamamen Sil</button>
        </div>
    </div>
</div>

<div class="modal fade" id="ekleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Yeni Karar</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <input type="text" class="form-control mb-2" id="e_metin" placeholder="Karar Metni">
                <select class="form-select mb-2" id="e_kategori"><option>Genel</option><option>Mali</option><option>Etkinlik</option></select>
                <input type="text" class="form-control mb-2" id="e_sorumlu" placeholder="Sorumlu">
                <input type="date" class="form-control mb-2" id="e_sonTarih">
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-primary" onclick="kararEkle()">Kaydet</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="duzenleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">D√ºzenle</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <input type="hidden" id="d_id">
                <input type="text" class="form-control mb-2" id="d_metin">
                <select class="form-select mb-2" id="d_kategori"><option>Genel</option><option>Mali</option><option>Etkinlik</option></select>
                <input type="text" class="form-control mb-2" id="d_sorumlu">
                <input type="date" class="form-control mb-2" id="d_sonTarih">
                <select class="form-select mb-2" id="d_durum"><option>Bekliyor</option><option>ƒ∞≈ülemde</option><option>Tamamlandƒ±</option><option>ƒ∞ptal</option></select>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-primary" onclick="kararGuncelle()">G√ºncelle</button></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- G√úNCEL URL BURAYA ---
    const API_URL = "https://script.google.com/macros/s/AKfycbyG8muIV2ThUr4HAbYEVCnjG9WDQcEWlEdGEUKlEULg_vZQYSO9DtK_JTL-qJwWBLQk4g/exec";
    
    let currentSheetName = ""; // Se√ßili proje adƒ± burada tutulur

    window.onload = loadProjects;

    function loader(show) { document.getElementById('loader').className = show ? "text-center py-5" : "hidden"; }

    // --- PROJE Lƒ∞STESƒ∞ ƒ∞≈ûLEMLERƒ∞ ---
    async function loadProjects() {
        showProjectList();
        loader(true);
        try {
            const res = await fetch(API_URL + "?action=getProjects");
            const projects = await res.json();
            const container = document.getElementById('projectContainer');
            container.innerHTML = "";
            
            projects.forEach(p => {
                container.innerHTML += `
                <div class="col-md-4 mb-3">
                    <div class="card project-card p-3" onclick="openProject('${p}')">
                        <h5 class="mb-0">${p}</h5>
                        <small class="text-muted">Detaylar i√ßin tƒ±kla &rarr;</small>
                    </div>
                </div>`;
            });
        } catch(e) { alert("Projeler y√ºklenemedi"); }
        finally { loader(false); }
    }

    async function yeniProjeEkle() {
        const ad = prompt("Yeni Proje Adƒ±:");
        const sifre = prompt("Y√∂netici ≈ûifresi:");
        if(!ad || !sifre) return;
        
        loader(true);
        const res = await fetch(API_URL + "?action=createProject&name=" + encodeURIComponent(ad) + "&key=" + sifre);
        const data = await res.json();
        
        if(data.status === "success") { loadProjects(); } 
        else { alert("Hata: " + data.message); loader(false); }
    }
    
    async function projeSil() {
        if(!confirm("Dƒ∞KKAT! Bu projeyi ve i√ßindeki T√úM verileri silmek √ºzeresiniz.")) return;
        const sifre = prompt("Onaylamak i√ßin ≈üifreyi girin:");
        if(!sifre) return;

        loader(true);
        const res = await fetch(API_URL + "?action=deleteProject&name=" + encodeURIComponent(currentSheetName) + "&key=" + sifre);
        const data = await res.json();
        if(data.status === "success") { loadProjects(); }
        else { alert(data.message); loader(false); }
    }

    // --- DASHBOARD (KARAR) ƒ∞≈ûLEMLERƒ∞ ---
    function openProject(name) {
        currentSheetName = name;
        document.getElementById('currentProjectTitle').innerText = name;
        document.getElementById('projectListView').classList.add('hidden');
        document.getElementById('dashboardView').classList.remove('hidden');
        document.getElementById('backBtn').classList.remove('hidden');
        kararlariGetir();
    }

    function showProjectList() {
        document.getElementById('dashboardView').classList.add('hidden');
        document.getElementById('backBtn').classList.add('hidden');
        document.getElementById('projectListView').classList.remove('hidden');
    }

    async function kararlariGetir() {
        loader(true);
        const res = await fetch(API_URL + "?action=read&sheetName=" + encodeURIComponent(currentSheetName));
        const data = await res.json();
        
        const tbody = document.getElementById('tabloGovdesi');
        tbody.innerHTML = "";

        if(data.length > 0) {
            // ƒ∞statistikler
            document.getElementById('statTotal').innerText = data.length;
            document.getElementById('statPending').innerText = data.filter(x => x.Durum === 'Bekliyor').length;
            document.getElementById('statDone').innerText = data.filter(x => x.Durum === 'Tamamlandƒ±').length;
            
            data.reverse().forEach(item => {
                let color = item.Durum === 'Tamamlandƒ±' ? 'success' : (item.Durum === 'ƒ∞ptal' ? 'danger' : 'warning');
                tbody.innerHTML += `
                    <tr>
                        <td>#${item.ID}</td>
                        <td>${formatDate(item.Tarih)}</td>
                        <td>${item['Karar Metni']}</td>
                        <td>${item.Sorumlu}</td>
                        <td><span class="badge bg-${color}">${item.Durum}</span></td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-primary" onclick='modalAc(${JSON.stringify(item)})'><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-outline-danger" onclick="kararSil(${item.ID})"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
        } else {
             tbody.innerHTML = "<tr><td colspan='6' class='text-center'>Hen√ºz kayƒ±t yok.</td></tr>";
        }
        loader(false);
    }

    // CRUD ƒ∞≈ülemleri (sheetName parametresi ekli)
    async function kararEkle() {
        const sifre = prompt("≈ûifre:"); if(!sifre) return;
        const veri = {
            kararMetni: document.getElementById('e_metin').value,
            kategori: document.getElementById('e_kategori').value,
            sorumlu: document.getElementById('e_sorumlu').value,
            sonTarih: document.getElementById('e_sonTarih').value
        };
        loader(true);
        await fetch(API_URL + "?action=add&sheetName=" + encodeURIComponent(currentSheetName) + "&key=" + sifre, {
            method: "POST", body: JSON.stringify(veri)
        });
        bootstrap.Modal.getInstance(document.getElementById('ekleModal')).hide();
        kararlariGetir();
    }

    async function kararSil(id) {
        if(!confirm("Silinsin mi?")) return;
        const sifre = prompt("≈ûifre:"); if(!sifre) return;
        loader(true);
        await fetch(API_URL + "?action=delete&id=" + id + "&sheetName=" + encodeURIComponent(currentSheetName) + "&key=" + sifre);
        kararlariGetir();
    }

    function modalAc(item) {
        document.getElementById('d_id').value = item.ID;
        document.getElementById('d_metin').value = item['Karar Metni'];
        document.getElementById('d_kategori').value = item.Kategori;
        document.getElementById('d_sorumlu').value = item.Sorumlu;
        document.getElementById('d_sonTarih').value = item['Son Tarih'];
        document.getElementById('d_durum').value = item.Durum;
        new bootstrap.Modal(document.getElementById('duzenleModal')).show();
    }

    async function kararGuncelle() {
        const sifre = prompt("≈ûifre:"); if(!sifre) return;
        const veri = {
            id: document.getElementById('d_id').value,
            kararMetni: document.getElementById('d_metin').value,
            kategori: document.getElementById('d_kategori').value,
            sorumlu: document.getElementById('d_sorumlu').value,
            sonTarih: document.getElementById('d_sonTarih').value,
            durum: document.getElementById('d_durum').value
        };
        loader(true);
        await fetch(API_URL + "?action=update&sheetName=" + encodeURIComponent(currentSheetName) + "&key=" + sifre, {
            method: "POST", body: JSON.stringify(veri)
        });
        bootstrap.Modal.getInstance(document.getElementById('duzenleModal')).hide();
        kararlariGetir();
    }

    function formatDate(d) { return d && d.includes("T") ? d.split("T")[0] : d; }
</script>
</body>
</html>
