<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Y√∂netim Panosu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        .project-card { cursor: pointer; transition: transform 0.2s; border-left: 5px solid #0d6efd; }
        .project-card:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .hidden { display: none !important; }
        
        /* Gƒ∞Rƒ∞≈û EKRANI (OVERLAY) */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #212529; z-index: 9999;
            display: flex; align-items: center; justify-content: center;
        }
        .login-box { background: white; padding: 2rem; border-radius: 10px; width: 100%; max-width: 400px; text-align: center; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box shadow-lg">
        <h3 class="mb-4"><i class="fas fa-lock text-primary"></i> G√ºvenli Giri≈ü</h3>
        <p class="text-muted small">Y√∂netici ≈üifresiyle giri≈ü yapƒ±n.</p>
        <input type="password" id="loginPass" class="form-control mb-3 text-center" placeholder="≈ûifre" onkeyup="if(event.key === 'Enter') login()">
        <button class="btn btn-primary w-100" onclick="login()">Giri≈ü Yap</button>
        <p id="loginError" class="text-danger mt-2 small hidden">Hatalƒ± ≈ûifre!</p>
    </div>
</div>

<div id="mainApp" class="hidden">
    <nav class="navbar navbar-dark bg-dark mb-4">
        <div class="container">
            <span class="navbar-brand"><i class="fas fa-layer-group me-2"></i>Dernek Proje Sistemi</span>
            <div>
                <button id="backBtn" class="btn btn-outline-light btn-sm hidden me-2" onclick="showProjectList()">
                    <i class="fas fa-arrow-left"></i> Projeler
                </button>
                <button class="btn btn-danger btn-sm" onclick="logout()" title="√áƒ±kƒ±≈ü Yap"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div id="loader" class="text-center py-5 hidden"><div class="spinner-border text-primary"></div><p>ƒ∞≈ülem yapƒ±lƒ±yor...</p></div>

        <div id="projectListView">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>üìÅ Projeler</h4>
                <button class="btn btn-success" onclick="yeniProjeEkle()"><i class="fas fa-plus"></i> Yeni Proje</button>
            </div>
            <div class="row" id="projectContainer"></div>
        </div>

        <div id="dashboardView" class="hidden">
            <h3 id="currentProjectTitle" class="mb-3 text-primary border-bottom pb-2"></h3>
            
            <div class="row mb-3 text-center">
                <div class="col-4"><div class="card p-2 bg-white"><h4 id="statTotal">0</h4><small>Toplam</small></div></div>
                <div class="col-4"><div class="card p-2 bg-white"><h4 id="statPending" class="text-warning">0</h4><small>Bekleyen</small></div></div>
                <div class="col-4"><div class="card p-2 bg-white"><h4 id="statDone" class="text-success">0</h4><small>Bitti</small></div></div>
            </div>

            <button class="btn btn-primary w-100 mb-3" data-bs-toggle="modal" data-bs-target="#ekleModal">
                <i class="fas fa-plus-circle"></i> Karar Ekle
            </button>

            <div class="card p-3">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light"><tr><th>ID</th><th>Tarih</th><th>Karar</th><th>Sorumlu</th><th>Durum</th><th class="text-end">ƒ∞≈ülem</th></tr></thead>
                        <tbody id="tabloGovdesi"></tbody>
                    </table>
                </div>
            </div>
            
            <div class="mt-5 text-center">
                 <button class="btn btn-outline-danger btn-sm" onclick="projeSil()"><i class="fas fa-trash-alt"></i> Bu Projeyi Tamamen Sil</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="ekleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Yeni Karar</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <input type="text" class="form-control mb-2" id="e_metin" placeholder="Karar Metni">
                <select class="form-select mb-2" id="e_kategori"><option>Genel</option><option>Mali</option><option>Etkinlik</option></select>
                <input type="text" class="form-control mb-2" id="e_sorumlu" placeholder="Sorumlu">
                <input type="date" class="form-control mb-2" id="e_sonTarih">
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-primary" onclick="kararEkle()">Kaydet</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="duzenleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">D√ºzenle</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <input type="hidden" id="d_id">
                <input type="text" class="form-control mb-2" id="d_metin">
                <select class="form-select mb-2" id="d_kategori"><option>Genel</option><option>Mali</option><option>Etkinlik</option></select>
                <input type="text" class="form-control mb-2" id="d_sorumlu">
                <input type="date" class="form-control mb-2" id="d_sonTarih">
                <select class="form-select mb-2" id="d_durum"><option>Bekliyor</option><option>ƒ∞≈ülemde</option><option>Tamamlandƒ±</option><option>ƒ∞ptal</option></select>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-primary" onclick="kararGuncelle()">G√ºncelle</button></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- URL BURAYA ---
    const API_URL = "https://script.google.com/macros/s/AKfycbzgwTw946a3NdQJeHsAvwAQuTj_4p-sWRxJgnPJAedJEeGm-Lg91s003c-AbwhAH6SBiA/exec";
    
    // ≈ûƒ∞FREYƒ∞ HAFIZADA TUTAN DEƒûƒ∞≈ûKEN
    let SESSION_KEY = ""; 
    let currentSheetName = "";

    function loader(show) { document.getElementById('loader').className = show ? "text-center py-5" : "hidden"; }

    // --- Gƒ∞Rƒ∞≈û Sƒ∞STEMƒ∞ ---
    async function login() {
        const pass = document.getElementById('loginPass').value;
        if(!pass) return;

        const btn = document.querySelector('.login-box button');
        btn.disabled = true; btn.innerText = "Kontrol ediliyor...";
        
        try {
            // ≈ûifreyi test etmek i√ßin projeleri √ßekmeyi deniyoruz
            const res = await fetch(API_URL + "?action=getProjects&key=" + pass);
            const data = await res.json();

            if (data.status === "error") {
                document.getElementById('loginError').classList.remove('hidden');
                btn.disabled = false; btn.innerText = "Giri≈ü Yap";
            } else {
                // ≈ûifre Doƒüru!
                SESSION_KEY = pass; // ≈ûifreyi deƒüi≈ükene kaydet
                document.getElementById('loginOverlay').style.display = 'none'; // Giri≈ü ekranƒ±nƒ± gizle
                document.getElementById('mainApp').classList.remove('hidden'); // Uygulamayƒ± a√ß
                renderProjects(data); // Listeyi bas
            }
        } catch(e) { 
            alert("Baƒülantƒ± hatasƒ±! ƒ∞nternetini veya URL'yi kontrol et."); 
            console.error(e);
            btn.disabled = false; btn.innerText = "Giri≈ü Yap"; 
        }
    }

    function logout() {
        location.reload(); // Sayfayƒ± yenilemek ≈üifreyi hafƒ±zadan siler
    }

    // --- PROJE ƒ∞≈ûLEMLERƒ∞ ---
    function renderProjects(projects) {
        const container = document.getElementById('projectContainer');
        container.innerHTML = "";
        projects.forEach(p => {
            container.innerHTML += `
            <div class="col-md-4 mb-3">
                <div class="card project-card p-3" onclick="openProject('${p}')">
                    <h5 class="mb-0">${p}</h5>
                    <small class="text-muted">G√∂r√ºnt√ºle &rarr;</small>
                </div>
            </div>`;
        });
    }

    async function loadProjects() {
        loader(true);
        // Artƒ±k key parametresine SESSION_KEY deƒüi≈ükenini koyuyoruz
        const res = await fetch(API_URL + "?action=getProjects&key=" + SESSION_KEY);
        const data = await res.json();
        renderProjects(data);
        loader(false);
    }

    async function yeniProjeEkle() {
        const ad = prompt("Yeni Proje Adƒ±:");
        if(!ad) return;
        loader(true);
        // Prompt yok, SESSION_KEY kullanƒ±lƒ±yor
        const res = await fetch(API_URL + "?action=createProject&name=" + encodeURIComponent(ad) + "&key=" + SESSION_KEY);
        const data = await res.json();
        if(data.status === "success") { loadProjects(); } else { alert(data.message); loader(false); }
    }
    
    async function projeSil() {
        if(!confirm("Bu proje tamamen silinecek! Emin misiniz?")) return;
        loader(true);
        const res = await fetch(API_URL + "?action=deleteProject&name=" + encodeURIComponent(currentSheetName) + "&key=" + SESSION_KEY);
        const data = await res.json();
        if(data.status === "success") { showProjectList(); loadProjects(); } else { alert(data.message); loader(false); }
    }

    // --- DASHBOARD ƒ∞≈ûLEMLERƒ∞ ---
    function openProject(name) {
        currentSheetName = name;
        document.getElementById('currentProjectTitle').innerText = name;
        document.getElementById('projectListView').classList.add('hidden');
        document.getElementById('dashboardView').classList.remove('hidden');
        document.getElementById('backBtn').classList.remove('hidden');
        kararlariGetir();
    }

    function showProjectList() {
        document.getElementById('dashboardView').classList.add('hidden');
        document.getElementById('backBtn').classList.add('hidden');
        document.getElementById('projectListView').classList.remove('hidden');
    }

    async function kararlariGetir() {
        loader(true);
        const res = await fetch(API_URL + "?action=read&sheetName=" + encodeURIComponent(currentSheetName) + "&key=" + SESSION_KEY);
        const data = await res.json();
        
        const tbody = document.getElementById('tabloGovdesi');
        tbody.innerHTML = "";

        if(data.length > 0 && !data.status) { 
            document.getElementById('statTotal').innerText = data.length;
            document.getElementById('statPending').innerText = data.filter(x => x.Durum === 'Bekliyor').length;
            document.getElementById('statDone').innerText = data.filter(x => x.Durum === 'Tamamlandƒ±').length;
            
            data.reverse().forEach(item => {
                let color = item.Durum === 'Tamamlandƒ±' ? 'success' : (item.Durum === 'ƒ∞ptal' ? 'danger' : 'warning');
                tbody.innerHTML += `
                    <tr>
                        <td>#${item.ID}</td>
                        <td>${formatDate(item.Tarih)}</td>
                        <td>${item['Karar Metni']}</td>
                        <td>${item.Sorumlu}</td>
                        <td><span class="badge bg-${color}">${item.Durum}</span></td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-primary" onclick='modalAc(${JSON.stringify(item)})'><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-outline-danger" onclick="kararSil(${item.ID})"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
        } else { tbody.innerHTML = "<tr><td colspan='6' class='text-center'>Veri yok.</td></tr>"; }
        loader(false);
    }

    async function kararEkle() {
        const veri = {
            kararMetni: document.getElementById('e_metin').value,
            kategori: document.getElementById('e_kategori').value,
            sorumlu: document.getElementById('e_sorumlu').value,
            sonTarih: document.getElementById('e_sonTarih').value
        };
        loader(true);
        // Otomatik SESSION_KEY kullanƒ±mƒ±
        await fetch(API_URL + "?action=add&sheetName=" + encodeURIComponent(currentSheetName) + "&key=" + SESSION_KEY, { method: "POST", body: JSON.stringify(veri) });
        bootstrap.Modal.getInstance(document.getElementById('ekleModal')).hide();
        kararlariGetir();
    }

    async function kararSil(id) {
        if(!confirm("Silinsin mi?")) return;
        loader(true);
        await fetch(API_URL + "?action=delete&id=" + id + "&sheetName=" + encodeURIComponent(currentSheetName) + "&key=" + SESSION_KEY);
        kararlariGetir();
    }

    async function kararGuncelle() {
        const veri = {
            id: document.getElementById('d_id').value,
            kararMetni: document.getElementById('d_metin').value,
            kategori: document.getElementById('d_kategori').value,
            sorumlu: document.getElementById('d_sorumlu').value,
            sonTarih: document.getElementById('d_sonTarih').value,
            durum: document.getElementById('d_durum').value
        };
        loader(true);
        await fetch(API_URL + "?action=update&sheetName=" + encodeURIComponent(currentSheetName) + "&key=" + SESSION_KEY, { method: "POST", body: JSON.stringify(veri) });
        bootstrap.Modal.getInstance(document.getElementById('duzenleModal')).hide();
        kararlariGetir();
    }

    function modalAc(item) {
        document.getElementById('d_id').value = item.ID;
        document.getElementById('d_metin').value = item['Karar Metni'];
        document.getElementById('d_kategori').value = item.Kategori;
        document.getElementById('d_sorumlu').value = item.Sorumlu;
        document.getElementById('d_sonTarih').value = item['Son Tarih'];
        document.getElementById('d_durum').value = item.Durum;
        new bootstrap.Modal(document.getElementById('duzenleModal')).show();
    }

    function formatDate(d) { return d && d.includes("T") ? d.split("T")[0] : d; }
</script>
</body>
</html>
